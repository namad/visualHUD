/**
 * HUDManager is user to manage all HUD design operations
 * Full CRUD cycle for every supported HUD Item
 * @type {*}
 */
visualHUD.Controllers.HUDManager = Backbone.Controller.extend({
    views: [
        'HUDItem',
        'HUDItemForm'
    ],

    models: [
        'HUDItem',
        'ClientSettings'
    ],

    collections: [
        'HUDItemTemplates',
        'HUDItemIconEnums',
        'HUDItems'
    ],

    AUTOSAVE_TIMEOUT: 300000,

    initialize: function(options) {
        this.addListeners({
            'StageControls': {
                'item.drop': this.dropNewHUDItem
            },
            'Canvas': {
                'drop.move': this.onItemMove
            },
            'GroupActionsPanel': {
                'align.action': this.alignItems,
                'group.action':  this.groupActions
            },
            'LoadWindow': {
                'load': this.loadHUD
            },
            'Form': {
                'align.action': this.alignItems,
                'arrange.action': this.arrangeItems
            },
            'HUDItem': {
                'click': this.onHUDItemClick
            },
            // Events generated by KeyboardManager Controller
            'keyboard': {
                'select.all': this.selectAllHUDItems,
                'delete': this.deleteSelectedItems,
                'move': this.moveSelectedItems,
                'group': this.groupSelectedItems
            }
        });
    },

    onLaunch: function() {
        var HUDItemsCollection = this.getCollection('HUDItems');
        var clientSettingsModel = this.getModel('ClientSettings');

        clientSettingsModel.on('change', this.updateHUDItemStatus, this);

        HUDItemsCollection.on('add', this.addNewHUDItem, this);
        HUDItemsCollection.on('load', this.loadDraft, this);

        // Load saved HUD Items
        $(window).load(visualHUD.Function.bind(HUDItemsCollection.load, HUDItemsCollection, []));
    },

    /**
     * Event handler triggered by visualHUD.Collections.HUDItems
     * Restore previously saved draft
     */
    loadDraft: function() {
        var canvasView = this.application.getController('Viewport').getView('Canvas'),
            trash = [];
        canvasView.beginUpdate();

        this.getCollection('HUDItems').each(function(record) {
            // using try catch in order to skip damaged/incorrect hud items
            try {
                this.createNewHUDItem(record);
            }
            catch(e) {
                trash.push(record);
                console.warn('Invalid HUD Data!', e.message);
            }
        }, this);
        // remove damaged items from collection
        this.getCollection('HUDItems').remove(trash);
        canvasView.completeUpdate();
    },

    /**
     * Event handler triggered by StageControls View when new HUD Item has been dropped to the canvas
     * @param record
     * @param position
     */
    dropNewHUDItem: function(record, position) {
        var HUDItemModelClass = this.getModelConstructor('HUDItem');
        var HUDItemModel = new HUDItemModelClass();
        var statusText = this.getModel('ClientSettings').getStatusByName(record.get('id'));

        HUDItemModel.setDefaultValues({
            name: record.get('id'),
            itemType: record.get('itemType')
        }).set({
            cssClass: record.get('cssClass'),
            label: record.get('label'),
            coordinates: position
        });

        HUDItemModel.wasDropped = true;

        if(statusText) {
            HUDItemModel.set('text', statusText);
        }

        this.getCollection('HUDItems').add(HUDItemModel);
    },

    /**
     * Create new visualHUD.Views.HUDItem instance based on visualHUD.Models.HUDItem data
     * @param record
     * @return {*}
     */
    createNewHUDItem: function(record) {
        var HUDItemTemplates = this.getCollection('HUDItemTemplates');
        var canvasView = this.application.getController('Viewport').getView('Canvas');
        var viewportView = this.application.getController('Viewport').getView('Viewport');

        var HUDItemViewClass = this.getViewConstructor('HUDItem');
        var formViewClass = this.getViewConstructor('HUDItemForm');
        var HUDItemIconEnums = this.getCollection('HUDItemIconEnums')

        var formView = new formViewClass({
            alias: 'Form',
            model: record,
            renderTo: viewportView.$sidebarArea,
            collections: {
                'HUDItemIconEnums': HUDItemIconEnums
            }
        });

        var HUDItem = new HUDItemViewClass({
            alias: 'HUDItem',
            HUDItemIconEnums: HUDItemIconEnums,
            renderTo: canvasView.$canvas,
            model: record,
            wasDropped: record.wasDropped,
            formView: formView,
            htmlTplRecord: HUDItemTemplates.get(record.get('name'))
        });

        return HUDItem;
    },

    /**
     * Event handler triggered by visualHUD.Collections.HUDItems when new record has been added to the collection
     * @param record
     */
    addNewHUDItem: function(record) {
        var canvasView = this.application.getController('Viewport').getView('Canvas');
        var HUDItem = this.createNewHUDItem(record);
        canvasView.select(HUDItem, false);
    },

    /**
     * Event handler Triggered by visualHUD.Libs.canvasDragInterface
     * @param HUDElementView
     */
    onItemMove: function(HUDElementView) {
        var canvasView = this.application.getController('Viewport').getView('Canvas');

        _.each(canvasView.getSelection(), function(view) {
            view.refreshCoordinates();
        });
    },

    onHUDItemClick: function(HUDItem, event) {
        var canvasView = this.application.getController('Viewport').getView('Canvas');
        this.application.getController('FocusManager').blur();
        canvasView.select(HUDItem, event.shiftKey || event.ctrlKey);
    },

    /**
     * Event handler Triggered by visualHUD.Models.ClientSettings
     * Used to update status of the particular HUD Item
     * @param model
     * @param options
     */
    updateHUDItemStatus: function(model, event) {
        var changes = event.changes;
        var HUDItemsCollection = this.getCollection('HUDItems');

        _.each(changes, function(set, field) {
            var value = model.get(field),
                namePattern;

            switch(field) {
                case 'statusHealth': {
                    namePattern = /healthIndicator|healthBar/
                    break;
                }
                case 'statusArmor': {
                    namePattern = /armorIndicator|armorBar/
                    break;
                }
                case 'statusAmmo': {
                    namePattern = /ammoIndicator/
                    break;
                }
                case 'statusAccuracy': {
                    namePattern = /accuracyIndicator/
                    break;
                }
                case 'statusSkill': {
                    namePattern = /skillIndicator/
                    break;
                }
            }

            HUDItemsCollection.each(function(record){
                var name = record.get('name');

                if(namePattern && namePattern.test(name)) {
                    record.set('text', value);
                }
            });
        }, this);
    },

    alignItems: function(value){
        var canvasView = this.application.getController('Viewport').getView('Canvas');
        visualHUD.Libs.layersManager.alignEdges(canvasView, value);

        _.each(canvasView.getSelection(), function(view) {
            view.refreshCoordinates();
        });
    },

    arrangeItems: function(value){
        var canvasView = this.application.getController('Viewport').getView('Canvas');
        visualHUD.Libs.layersManager.arrangeLayers(canvasView, value);
    },

    groupActions: function(action){
        switch(action) {
            case 'delete-selected': {
                this.deleteSelectedItems();
                break;
            }
            case 'group-selected': {
                this.groupSelectedItems();
                break;
            }
        }
    },

    /**
     * Event triggered by KeyboardManager controller when pressing DEL button
     */
    deleteSelectedItems: function() {
        var canvas = this.application.getController('Viewport').getView('Canvas'),
            selection = canvas.getSelection();

        _.each(selection, function(view) {
            view.model.destroy();
        });

        canvas.deselect();
    },

    /**
     * Event triggered by KeyboardManager controller when pressing arrow buttons
     * @param direction
     * @param offset
     */
    moveSelectedItems: function(direction, offset) {
        var canvas = this.application.getController('Viewport').getView('Canvas'),
            selection = canvas.getSelection();

        _.each(selection, function(view) {
            view.move(direction, offset);
        });
    },

    selectAllHUDItems: function(event) {
        var canvas = this.application.getController('Viewport').getView('Canvas');
        canvas.selectAll();
    },

    groupSelectedItems: function() {
        var canvas = this.application.getController('Viewport').getView('Canvas'),
            selection = canvas.getSelection(),
            masterElement = selection[0];
            isUngroup = false,
            groupGuid = null;

        _.each(selection, function(view) {
            if(view.getGroup()) {
                isUngroup = true;
            }
            else {
                groupGuid = groupGuid || visualHUD.Libs.utility.getGuid();
            }
            view.setGroup(groupGuid);
        });

        if(isUngroup == true) {
            canvas.deselect();
            canvas.select(masterElement);
        }
    },


    loadHUD: function(data) {
        this.application.getController('Viewport').getView('Canvas').beginUpdate();

        this.selectAllHUDItems();
        this.deleteSelectedItems();

        this.getCollection('HUDItems').load(data);
    }
});

